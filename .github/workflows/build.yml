name: Build All Platforms

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  analyze:
    name: Analyze & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.6"
          channel: "stable"
          cache: true
      - run: flutter pub get
      - run: flutter analyze --no-fatal-infos
      - run: flutter test

  build-android:
    name: Build Android
    needs: analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.6"
          channel: "stable"
          cache: true
      - run: flutter pub get
      - run: flutter build apk --release
      - uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk

  # build-ios:
  #   name: Build iOS
  #   needs: analyze
  #   runs-on: macos-latest
  #   env:
  #     APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Install Apple Certificate
  #       env:
  #         P12_CERTIFICATE: ${{ secrets.APPLE_P12_CERTIFICATE }}
  #         P12_PASSWORD: ${{ secrets.APPLE_P12_PASSWORD }}
  #         PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE }}
  #         KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
  #       run: |
  #         CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
  #         PROFILE_PATH=$RUNNER_TEMP/profile.mobileprovision
  #         KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
  #         echo -n "$P12_CERTIFICATE" | base64 --decode -o $CERTIFICATE_PATH
  #         echo -n "$PROVISIONING_PROFILE" | base64 --decode -o $PROFILE_PATH
  #         security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
  #         security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
  #         security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
  #         security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
  #         security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
  #         security list-keychain -d user -s $KEYCHAIN_PATH
  #         mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
  #         cp $PROFILE_PATH ~/Library/MobileDevice/Provisioning\ Profiles/
  #     - name: Generate ExportOptions.plist
  #       run: |
  #         cat > ios/ExportOptions.plist << EOF
  #         <?xml version="1.0" encoding="UTF-8"?>
  #         <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
  #         <plist version="1.0">
  #         <dict>
  #             <key>method</key>
  #             <string>app-store</string>
  #             <key>teamID</key>
  #             <string>${{ secrets.APPLE_TEAM_ID }}</string>
  #             <key>uploadSymbols</key>
  #             <true/>
  #             <key>compileBitcode</key>
  #             <false/>
  #         </dict>
  #         </plist>
  #         EOF
  #     - uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: '3.24.0'
  #         channel: 'stable'
  #         cache: true
  #     - run: flutter pub get
  #     - run: flutter build ipa --release --export-options-plist=ios/ExportOptions.plist
  #     - uses: actions/upload-artifact@v4
  #       with:
  #         name: ios-ipa
  #         path: build/ios/ipa/*.ipa
  #     - name: Cleanup keychain
  #       if: always()
  #       run: security delete-keychain $RUNNER_TEMP/app-signing.keychain-db

  build-web:
    name: Build Web
    needs: analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.6"
          channel: "stable"
          cache: true
      - run: flutter pub get
      - run: flutter build web --release
      - uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web

  build-windows:
    name: Build Windows
    needs: analyze
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.6"
          channel: "stable"
          cache: true
      - run: flutter pub get
      - run: flutter build windows --release
      - uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: build/windows/x64/runner/Release

  build-linux:
    name: Build Linux
    needs: analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.6"
          channel: "stable"
          cache: true
      - run: flutter pub get
      - run: flutter build linux --release
      - uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: build/linux/x64/release/bundle

  # build-macos:
  #   name: Build macOS
  #   needs: analyze
  #   runs-on: macos-latest
  #   env:
  #     APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Install Apple Certificate
  #       env:
  #         P12_CERTIFICATE: ${{ secrets.APPLE_P12_CERTIFICATE }}
  #         P12_PASSWORD: ${{ secrets.APPLE_P12_PASSWORD }}
  #         KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
  #       run: |
  #         CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
  #         KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
  #         echo -n "$P12_CERTIFICATE" | base64 --decode -o $CERTIFICATE_PATH
  #         security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
  #         security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
  #         security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
  #         security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
  #         security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
  #         security list-keychain -d user -s $KEYCHAIN_PATH
  #     - uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: '3.24.0'
  #         channel: 'stable'
  #         cache: true
  #     - run: flutter pub get
  #     - run: flutter build macos --release
  #     - name: Sign and Notarize
  #       env:
  #         APPLE_ID: ${{ secrets.APPLE_ID }}
  #         APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
  #         DEVELOPER_ID: "Developer ID Application: ${{ secrets.APPLE_DEVELOPER_NAME }} (${{ secrets.APPLE_TEAM_ID }})"
  #       run: |
  #         APP_PATH="build/macos/Build/Products/Release/words.app"
  #         ZIP_PATH="build/macos/words.zip"
  #         codesign --deep --force --options runtime --sign "$DEVELOPER_ID" "$APP_PATH"
  #         ditto -c -k --keepParent "$APP_PATH" "$ZIP_PATH"
  #         xcrun notarytool submit "$ZIP_PATH" \
  #           --apple-id "$APPLE_ID" \
  #           --password "$APPLE_APP_PASSWORD" \
  #           --team-id "$APPLE_TEAM_ID" \
  #           --wait
  #         xcrun stapler staple "$APP_PATH"
  #     - uses: actions/upload-artifact@v4
  #       with:
  #         name: macos-build
  #         path: build/macos/Build/Products/Release/words.app
  #     - name: Cleanup keychain
  #       if: always()
  #       run: security delete-keychain $RUNNER_TEMP/app-signing.keychain-db
